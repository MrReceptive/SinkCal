<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Satisfactory AWESOME Sink Coupon Optimizer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      background: #23272e; 
      color: #f6f6f7; 
      padding: 24px; 
      max-width: 1200px; 
      margin: 0 auto; 
    }
    
    input, button, select, textarea { 
      font-size: 1em; 
      margin: 3px 0 10px 0; 
      padding: 8px 12px; 
      border: 1px solid #444;
      background: #2c3036;
      color: #f6f6f7;
      border-radius: 4px;
    }
    
    input[type="checkbox"] {
      margin: 0 8px 0 0;
      padding: 0;
      width: auto;
      height: auto;
      accent-color: #5865f2;
    }
    
    label:has(input[type="checkbox"]) {
      display: flex;
      align-items: center;
      font-weight: 600;
      cursor: pointer;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #7fdfff;
      box-shadow: 0 0 0 2px rgba(127, 223, 255, 0.2);
    }
    
    button {
      background: #5865f2;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background: #4752c4;
    }
    
    button:disabled {
      background: #4a4d55;
      cursor: not-allowed;
    }
    
    textarea { 
      width: 100%; 
      min-height: 54px; 
      resize: vertical;
      font-family: inherit;
    }
    
    .result { 
      background: #181a1b; 
      border-radius: 10px; 
      padding: 16px; 
      margin-top: 16px; 
      border: 1px solid #333;
    }
    
    .error {
      background: #d32f2f;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
    }
    
    th, td { 
      border-bottom: 1px solid #333; 
      padding: 8px 12px; 
      text-align: left;
    }
    
    th { 
      background: #32363e; 
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) { 
      background: #262a30; 
    }
    
    tr:hover {
      background: #2a2f35;
    }
    
    .small { 
      font-size: 0.9em; 
      opacity: 0.75; 
    }
    
    .cannot { 
      color: #ff6b6b; 
    }
    
    .event { 
      color: #7fdfff; 
      font-weight: 500;
    }
    
    summary { 
      cursor: pointer;
      padding: 8px 0;
      font-weight: 600;
    }
    
    details[open] summary {
      margin-bottom: 12px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .inventory-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 6px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    
    .stat-card {
      background: #2c3036;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #7fdfff;
    }
    
    .recommendations {
      counter-reset: recommendation-counter;
    }
    
    .recommendation-item {
      counter-increment: recommendation-counter;
      background: #2c3036;
      margin: 8px 0;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #5865f2;
    }
    
    .recommendation-item::before {
      content: counter(recommendation-counter) ". ";
      font-weight: 700;
      color: #7fdfff;
    }
    
    .item-name {
      font-weight: 600;
      color: #f6f6f7;
    }
    
    .item-details {
      margin-top: 4px;
      font-size: 0.9em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>AWESOME Sink Coupon Optimizer 
    <span class="small">(Enhanced with Production Tracking)</span>
  </h1>
  
  <div class="controls">
    <div class="control-group">
      <label for="tierSelect">Select your unlocked Tier:</label>
      <select id="tierSelect">
        <option value="1">Tier 1 (Hub Start)</option>
        <option value="2">Tier 2</option>
        <option value="3">Tier 3</option>
        <option value="4">Tier 4</option>
        <option value="5">Tier 5</option>
        <option value="6">Tier 6</option>
        <option value="7">Tier 7</option>
        <option value="8" selected>Tier 8 (Endgame/Everything)</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="numCoupons">Number of coupons wanted:</label>
      <input id="numCoupons" type="number" value="1" min="1" max="1000">
    </div>
    
    <div class="control-group">
      <label for="points">Points needed for next coupon:</label>
      <input id="points" type="number" value="500" min="0" placeholder="500">
      <div class="small">Enter the cost of your next coupon (500 for first coupon, 1250 for 4th-6th, etc.)</div>
    </div>
    
    <div class="control-group">
      <label for="sinkingRate">Current sinking rate (optional):</label>
      <input id="sinkingRate" type="number" value="" min="0" placeholder="e.g. 1200">
      <div class="small">Points per minute currently being sunk (for time estimates)</div>
    </div>
    
    <div class="control-group">
      <label for="factoryEfficiency">Factory efficiency:</label>
      <select id="factoryEfficiency">
        <option value="0.5">Basic (50%) - Small factory</option>
        <option value="1" selected>Good (100%) - Reasonable automation</option>
        <option value="1.5">Excellent (150%) - Large optimized factory</option>
        <option value="2">Mega Factory (200%) - Maximum efficiency</option>
      </select>
      <div class="small">Adjusts production rate estimates based on your factory setup</div>
    </div>
  </div>
  
  <div class="controls">
    <div class="control-group">
      <label>
        <input type="checkbox" id="showHandCrafted"> 
        Include hand-crafted items
      </label>
      <div class="small">By default, only items that can be automated are shown</div>
    </div>
  </div>
  
  <div class="control-group">
    <label for="customUnlocked">Custom unlocked items (optional):</label>
    <textarea id="customUnlocked" placeholder="Enter item names separated by commas or newlines. E.g: Iron Ingot, Reinforced Iron Plate, Computer"></textarea>
    <div class="small">Leave blank to use tier-based filtering</div>
  </div>
  
  <button id="calculateBtn" onclick="window.optimizer.calculate()">
    Find Best Items
  </button>
  
  <div id="errorContainer"></div>
  
  <details id="productionSection">
    <summary>Current Production Lines (Optional but Recommended)</summary>
    <div class="small" style="margin-bottom: 12px;">
      Tell us what you're already producing for much more accurate time estimates!
    </div>
    <div id="productionContainer"></div>
  </details>
  
  <details id="inventorySection">
    <summary>Show/Enter Current Inventory (Optional)</summary>
    <div id="inventoryContainer"></div>
  </details>
  
  <div id="resultsContainer"></div>

  <script>
    // Game data - all items with their properties
    const GAME_DATA = {
      cannotBeSunk: [
        "Alien Protein", "Bacon Agaric", "Beryl Nut", "Blue Power Slug", 
        "Encased Plutonium Cell", "FICSIT Coupon", "Ficsonium Fuel Rod", 
        "Ficsonium", "Hatcher Remains", "Hog Remains", "Mercer Sphere", 
        "Non-Fissile Uranium", "Paleberry", "Plutonium Pellet", "Plutonium Waste", 
        "Power Shard", "Purple Power Slug", "Somersloop", "Spitter Remains", 
        "Stinger Remains", "Uranium Waste", "Yellow Power Slug"
      ],
      
      items: {
        "Iron Ore": { points: 1, tier: 9, automatable: true, productionRate: 2000, complexity: 1 },
        "Iron Ingot": { points: 2, tier: 1, automatable: true, productionRate: 1000, complexity: 1 },
        "Limestone": { points: 2, tier: 1, automatable: true, productionRate: 2000, complexity: 1 },
        "Screws": { points: 2, tier: 1, automatable: true, productionRate: 800, complexity: 1 },
        "Coal": { points: 3, tier: 2, automatable: true, productionRate: 1500, complexity: 1 },
        "Copper Ore": { points: 3, tier: 2, automatable: true, productionRate: 1800, complexity: 1 },
        "Leaves": { points: 3, tier: 2, automatable: false, productionRate: 0, complexity: 1 },
        "Iron Rod": { points: 4, tier: 1, automatable: true, productionRate: 600, complexity: 1 },
        "Copper Ingot": { points: 6, tier: 1, automatable: true, productionRate: 900, complexity: 1 },
        "Iron Plate": { points: 6, tier: 1, automatable: true, productionRate: 400, complexity: 1 },
        "Wire": { points: 6, tier: 1, automatable: true, productionRate: 1200, complexity: 1 },
        "Caterium Ore": { points: 7, tier: 3, automatable: true, productionRate: 800, complexity: 1 },
        "Bauxite": { points: 8, tier: 4, automatable: true, productionRate: 600, complexity: 1 },
        "Iron Rebar": { points: 8, tier: 4, automatable: true, productionRate: 300, complexity: 2 },
        "Steel Ingot": { points: 8, tier: 4, automatable: true, productionRate: 500, complexity: 2 },
        "Mycelia": { points: 10, tier: 2, automatable: true, productionRate: 300, complexity: 1 },
        "Sulfur": { points: 11, tier: 3, automatable: true, productionRate: 800, complexity: 1 },
        "Biomass": { points: 12, tier: 1, automatable: false, productionRate: 0, complexity: 1 },
        "Concrete": { points: 12, tier: 1, automatable: true, productionRate: 400, complexity: 1 },
        "Polymer Resin": { points: 12, tier: 1, automatable: true, productionRate: 200, complexity: 2 },
        "Black Powder": { points: 14, tier: 3, automatable: true, productionRate: 150, complexity: 2 },
        "Raw Quartz": { points: 15, tier: 3, automatable: true, productionRate: 600, complexity: 1 },
        "Quickwire": { points: 17, tier: 3, automatable: true, productionRate: 800, complexity: 2 },
        "Petroleum Coke": { points: 20, tier: 4, automatable: true, productionRate: 300, complexity: 2 },
        "SAM": { points: 20, tier: 4, automatable: true, productionRate: 200, complexity: 1 },
        "Silica": { points: 20, tier: 4, automatable: true, productionRate: 300, complexity: 2 },
        "Cable": { points: 24, tier: 2, automatable: true, productionRate: 300, complexity: 2 },
        "Copper Sheet": { points: 24, tier: 2, automatable: true, productionRate: 200, complexity: 2 },
        "Steel Pipe": { points: 24, tier: 2, automatable: true, productionRate: 200, complexity: 2 },
        "Rifle Ammo": { points: 25, tier: 6, automatable: true, productionRate: 180, complexity: 3 },
        "Aluminum Scrap": { points: 27, tier: 7, automatable: true, productionRate: 400, complexity: 3 },
        "Compacted Coal": { points: 28, tier: 5, automatable: true, productionRate: 100, complexity: 3 },
        "Wood": { points: 30, tier: 1, automatable: false, productionRate: 0, complexity: 1 },
        "Uranium": { points: 35, tier: 7, automatable: true, productionRate: 100, complexity: 2 },
        "Caterium Ingot": { points: 42, tier: 3, automatable: true, productionRate: 400, complexity: 2 },
        "Solid Biofuel": { points: 48, tier: 2, automatable: true, productionRate: 150, complexity: 2 },
        "Quartz Crystal": { points: 50, tier: 3, automatable: true, productionRate: 200, complexity: 2 },
        "Smokeless Powder": { points: 58, tier: 4, automatable: true, productionRate: 80, complexity: 3 },
        "Empty Canister": { points: 60, tier: 3, automatable: true, productionRate: 120, complexity: 2 },
        "Rubber": { points: 60, tier: 3, automatable: true, productionRate: 120, complexity: 3 },
        "Steel Beam": { points: 64, tier: 4, automatable: true, productionRate: 200, complexity: 2 },
        "Copper Powder": { points: 72, tier: 5, automatable: true, productionRate: 150, complexity: 3 },
        "Plastic": { points: 75, tier: 5, automatable: true, productionRate: 200, complexity: 3 },
        "Reinforced Iron Plate": { points: 120, tier: 2, automatable: true, productionRate: 150, complexity: 2 },
        "Turbo Rifle Ammo": { points: 120, tier: 2, automatable: true, productionRate: 100, complexity: 3 },
        "Packaged Water": { points: 130, tier: 4, automatable: true, productionRate: 300, complexity: 2 },
        "Aluminum Ingot": { points: 131, tier: 7, automatable: true, productionRate: 300, complexity: 3 },
        "Fabric": { points: 140, tier: 3, automatable: true, productionRate: 80, complexity: 3 },
        "Rotor": { points: 140, tier: 3, automatable: true, productionRate: 100, complexity: 3 },
        "Encased Uranium Cell": { points: 147, tier: 7, automatable: true, productionRate: 50, complexity: 4 },
        "Nobelisk": { points: 152, tier: 5, automatable: true, productionRate: 60, complexity: 3 },
        "Packaged Sulfuric Acid": { points: 152, tier: 5, automatable: true, productionRate: 100, complexity: 3 },
        "Packaged Alumina Solution": { points: 160, tier: 7, automatable: true, productionRate: 200, complexity: 3 },
        "Reanimated SAM": { points: 160, tier: 7, automatable: true, productionRate: 60, complexity: 4 },
        "Empty Fluid Tank": { points: 170, tier: 5, automatable: true, productionRate: 80, complexity: 3 },
        "Packaged Heavy Oil Residue": { points: 180, tier: 5, automatable: true, productionRate: 150, complexity: 3 },
        "Packaged Oil": { points: 180, tier: 5, automatable: true, productionRate: 200, complexity: 2 },
        "Stun Rebar": { points: 186, tier: 4, automatable: true, productionRate: 50, complexity: 3 },
        "Alien Power Matrix": { points: 210, tier: 8, automatable: true, productionRate: 30, complexity: 5 },
        "Diamonds": { points: 240, tier: 5, automatable: true, productionRate: 80, complexity: 4 },
        "Stator": { points: 240, tier: 5, automatable: true, productionRate: 80, complexity: 3 },
        "Alclad Aluminum Sheet": { points: 266, tier: 7, automatable: true, productionRate: 120, complexity: 3 },
        "Packaged Fuel": { points: 270, tier: 5, automatable: true, productionRate: 150, complexity: 3 },
        "Packaged Nitrogen Gas": { points: 312, tier: 8, automatable: true, productionRate: 100, complexity: 4 },
        "Shatter Rebar": { points: 332, tier: 5, automatable: true, productionRate: 40, complexity: 4 },
        "Explosive Rebar": { points: 360, tier: 5, automatable: true, productionRate: 35, complexity: 4 },
        "Packaged Liquid Biofuel": { points: 370, tier: 6, automatable: true, productionRate: 80, complexity: 4 },
        "Aluminum Casing": { points: 393, tier: 7, automatable: true, productionRate: 100, complexity: 3 },
        "Modular Frame": { points: 408, tier: 4, automatable: true, productionRate: 60, complexity: 3 },
        "Packaged Nitric Acid": { points: 412, tier: 8, automatable: true, productionRate: 60, complexity: 4 },
        "Battery": { points: 465, tier: 6, automatable: true, productionRate: 50, complexity: 4 },
        "Smart Plating": { points: 520, tier: 4, automatable: true, productionRate: 40, complexity: 3 },
        "Encased Industrial Beam": { points: 528, tier: 5, automatable: true, productionRate: 60, complexity: 3 },
        "Gas Nobelisk": { points: 544, tier: 6, automatable: true, productionRate: 30, complexity: 4 },
        "Packaged Turbofuel": { points: 570, tier: 6, automatable: true, productionRate: 80, complexity: 4 },
        "Gas Filter": { points: 608, tier: 6, automatable: true, productionRate: 40, complexity: 4 },
        "Circuit Board": { points: 696, tier: 5, automatable: true, productionRate: 80, complexity: 4 },
        "Homing Rifle Ammo": { points: 855, tier: 6, automatable: true, productionRate: 25, complexity: 4 },
        "AI Limiter": { points: 920, tier: 5, automatable: true, productionRate: 50, complexity: 4 },
        "Time Crystal": { points: 960, tier: 8, automatable: true, productionRate: 20, complexity: 5 },
        "Packaged Rocket Fuel": { points: 1028, tier: 7, automatable: true, productionRate: 40, complexity: 4 },
        "Versatile Framework": { points: 1176, tier: 6, automatable: true, productionRate: 30, complexity: 4 },
        "Ficsite Trigon": { points: 1291, tier: 8, automatable: true, productionRate: 25, complexity: 5 },
        "Cluster Nobelisk": { points: 1376, tier: 8, automatable: true, productionRate: 15, complexity: 5 },
        "Automated Wiring": { points: 1440, tier: 5, automatable: true, productionRate: 40, complexity: 4 },
        "Motor": { points: 1520, tier: 4, automatable: true, productionRate: 50, complexity: 4 },
        "Pulse Nobelisk": { points: 1533, tier: 7, automatable: true, productionRate: 12, complexity: 5 },
        "Dark Matter Crystal": { points: 1780, tier: 8, automatable: true, productionRate: 15, complexity: 5 },
        "Ficsite Ingot": { points: 1936, tier: 8, automatable: true, productionRate: 30, complexity: 5 },
        "Iodine-Infused Filter": { points: 2274, tier: 6, automatable: true, productionRate: 20, complexity: 5 },
        "Electromagnetic Control Rod": { points: 2560, tier: 7, automatable: true, productionRate: 15, complexity: 5 },
        "Heat Sink": { points: 2804, tier: 6, automatable: true, productionRate: 25, complexity: 4 },
        "Crystal Oscillator": { points: 3072, tier: 6, automatable: true, productionRate: 20, complexity: 5 },
        "High-Speed Connector": { points: 3776, tier: 6, automatable: true, productionRate: 15, complexity: 5 },
        "Packaged Ionized Fuel": { points: 5246, tier: 8, automatable: true, productionRate: 12, complexity: 5 },
        "Computer": { points: 8352, tier: 6, automatable: true, productionRate: 15, complexity: 4 },
        "Modular Engine": { points: 9960, tier: 6, automatable: true, productionRate: 12, complexity: 5 },
        "Heavy Modular Frame": { points: 10800, tier: 6, automatable: true, productionRate: 8, complexity: 5 },
        "Magnetic Field Generator": { points: 11000, tier: 8, automatable: true, productionRate: 6, complexity: 5 },
        "Cooling System": { points: 12006, tier: 7, automatable: true, productionRate: 10, complexity: 5 },
        "Nuke Nobelisk": { points: 19600, tier: 8, automatable: true, productionRate: 5, complexity: 5 },
        "Radio Control Unit": { points: 32352, tier: 7, automatable: true, productionRate: 4, complexity: 5 },
        "Superposition Oscillator": { points: 37292, tier: 8, automatable: true, productionRate: 3, complexity: 5 },
        "Uranium Fuel Rod": { points: 43468, tier: 7, automatable: true, productionRate: 2, complexity: 5 },
        "Fused Modular Frame": { points: 62840, tier: 7, automatable: true, productionRate: 3, complexity: 5 },
        "Adaptive Control Unit": { points: 76368, tier: 7, automatable: true, productionRate: 2, complexity: 5 },
        "Supercomputer": { points: 97352, tier: 7, automatable: true, productionRate: 2, complexity: 5 },
        "Singularity Cell": { points: 114675, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Plutonium Fuel Rod": { points: 153184, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Turbo Motor": { points: 240496, tier: 7, automatable: true, productionRate: 2, complexity: 5 },
        "Neural-Quantum Processor": { points: 248034, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Pressure Conversion Cube": { points: 255088, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Biochemical Sculptor": { points: 301778, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Assembly Director System": { points: 500176, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Nuclear Pasta": { points: 538976, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "AI Expansion Server": { points: 597652, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Thermal Propulsion Rocket": { points: 728508, tier: 8, automatable: true, productionRate: 1, complexity: 5 },
        "Ballistic Warp Drive": { points: 2895334, tier: 8, automatable: true, productionRate: 0.5, complexity: 5 }
      }
    };

    // Configuration
    const CONFIG = {
      MAX_COUPONS: 1000,
      BASE_COUPON_COST: 500,
      COST_MULTIPLIER: 250,
      BASE_COST_OFFSET: 1000,
      MAX_COST: 249501250,
      MAX_DISPLAY_RECOMMENDATIONS: 15,
      FIRST_THREE_COUPONS: 3,
      HIGH_TIER_COUPON_LIMIT: 3000,
      COUPON_GROUP_SIZE: 3
    };

    // Utility functions
    function createSafeId(itemName) {
      return `inv_${itemName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
    }

    function sanitizeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    // Coupon calculation functions
    function calculateCouponCost(n) {
      if (n <= CONFIG.FIRST_THREE_COUPONS) {
        return CONFIG.BASE_COUPON_COST;
      }
      
      if (n > CONFIG.HIGH_TIER_COUPON_LIMIT) {
        return CONFIG.MAX_COST;
      }
      
      const group = Math.ceil(n / CONFIG.COUPON_GROUP_SIZE) - 1;
      return CONFIG.COST_MULTIPLIER * group * group + CONFIG.BASE_COST_OFFSET;
    }

    function calculateCouponsFromCost(currentCost) {
      if (currentCost === CONFIG.BASE_COUPON_COST) {
        return 1;
      }
      
      if (currentCost >= CONFIG.MAX_COST) {
        return CONFIG.HIGH_TIER_COUPON_LIMIT;
      }
      
      const base = Math.sqrt((currentCost - CONFIG.BASE_COST_OFFSET) / CONFIG.COST_MULTIPLIER);
      const minPrinted = CONFIG.COUPON_GROUP_SIZE * base;
      const maxPrinted = minPrinted + 2;
      
      return Math.floor((minPrinted + maxPrinted) / 2);
    }

    function calculateCumulativeCost(currentCostToNext, wantCoupons) {
      const alreadyPrinted = calculateCouponsFromCost(currentCostToNext);
      
      let totalNeeded = 0;
      totalNeeded += currentCostToNext;
      
      for (let i = 1; i < wantCoupons; i++) {
        const couponNumber = alreadyPrinted + 1 + i;
        totalNeeded += calculateCouponCost(couponNumber);
      }
      
      return {
        totalPointsNeeded: totalNeeded,
        alreadyPrinted: alreadyPrinted,
        nextCouponNumber: alreadyPrinted + 1,
        finalCouponNumber: alreadyPrinted + wantCoupons
      };
    }

    // Time formatting functions
    function formatTimeShort(totalMinutes) {
      if (totalMinutes < 1) return "< 1m";
      if (totalMinutes < 60) return `${Math.round(totalMinutes)}m`;
      
      const hours = Math.floor(totalMinutes / 60);
      const minutes = Math.round(totalMinutes % 60);
      
      if (hours < 24) {
        return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
      }
      
      const days = Math.floor(hours / 24);
      const remainingHours = hours % 24;
      
      if (days < 7) {
        return remainingHours > 0 ? `${days}d ${remainingHours}h` : `${days}d`;
      }
      
      const weeks = Math.floor(days / 7);
      const remainingDays = days % 7;
      
      return remainingDays > 0 ? `${weeks}w ${remainingDays}d` : `${weeks}w`;
    }

    function formatTimeLong(totalMinutes) {
      if (totalMinutes < 1) return "less than 1 minute";
      if (totalMinutes < 60) return `${Math.round(totalMinutes)} minute${Math.round(totalMinutes) !== 1 ? 's' : ''}`;
      
      const hours = Math.floor(totalMinutes / 60);
      const minutes = Math.round(totalMinutes % 60);
      
      if (hours < 24) {
        let result = `${hours} hour${hours !== 1 ? 's' : ''}`;
        if (minutes > 0) {
          result += ` and ${minutes} minute${minutes !== 1 ? 's' : ''}`;
        }
        return result;
      }
      
      const days = Math.floor(hours / 24);
      const remainingHours = hours % 24;
      
      let result = `${days} day${days !== 1 ? 's' : ''}`;
      if (remainingHours > 0) {
        result += ` and ${remainingHours} hour${remainingHours !== 1 ? 's' : ''}`;
      }
      return result;
    }

    // Item filtering and recommendation functions
    function getAvailableItems(selectedTier, customUnlocked, includeHandCrafted = false) {
      return Object.entries(GAME_DATA.items)
        .filter(([itemName, itemData]) => {
          if (GAME_DATA.cannotBeSunk.includes(itemName)) {
            return false;
          }
          
          if (!includeHandCrafted && !itemData.automatable) {
            return false;
          }
          
          if (customUnlocked) {
            return customUnlocked[itemName];
          }
          
          return itemData.tier <= selectedTier || 
                 (itemData.tier === 9 && selectedTier === 8);
        })
        .sort((a, b) => b[1].points - a[1].points);
    }

    function calculateTimeEstimate(pointsNeeded, sinkingRatePerMinute) {
      if (!sinkingRatePerMinute || sinkingRatePerMinute <= 0) {
        return null;
      }

      const totalMinutes = pointsNeeded / sinkingRatePerMinute;
      return {
        totalMinutes: Math.round(totalMinutes),
        formattedShort: formatTimeShort(totalMinutes),
        formattedLong: formatTimeLong(totalMinutes)
      };
    }

    function generateRecommendations(pointsNeeded, selectedTier, customUnlocked, inventory, includeHandCrafted = false, sinkingRate = null) {
      const availableItems = getAvailableItems(selectedTier, customUnlocked, includeHandCrafted);
      
      return availableItems
        .map(([itemName, itemData]) => {
          const needed = Math.ceil(pointsNeeded / itemData.points);
          const have = inventory[itemName] || 0;
          
          return {
            item: itemName,
            points: itemData.points,
            needed,
            have,
            isEvent: itemName.toLowerCase().includes('ficsmas'),
            isAutomatable: itemData.automatable,
            productionRate: itemData.productionRate,
            complexity: itemData.complexity
          };
        })
        .sort((a, b) => {
          const needDiff = a.needed - b.needed;
          return needDiff !== 0 ? needDiff : b.points - a.points;
        })
        .slice(0, CONFIG.MAX_DISPLAY_RECOMMENDATIONS);
    }

    // UI functions
    function getCurrentTier() {
      const tierSelect = document.getElementById('tierSelect');
      return tierSelect ? parseInt(tierSelect.value) : 8;
    }

    function getIncludeHandCrafted() {
      const checkbox = document.getElementById('showHandCrafted');
      return checkbox ? checkbox.checked : false;
    }

    function getCurrentSinkingRate() {
      const input = document.getElementById('sinkingRate');
      if (!input || !input.value.trim()) {
        return null;
      }
      const rate = parseInt(input.value);
      return isNaN(rate) || rate <= 0 ? null : rate;
    }

    function getCustomUnlocks() {
      const textarea = document.getElementById('customUnlocked');
      if (!textarea || !textarea.value.trim()) {
        return null;
      }

      const inputText = textarea.value.trim();
      const itemNames = inputText
        .replace(/,/g, '\n')
        .split(/\n/)
        .map(name => name.trim())
        .filter(name => name.length > 0);

      if (itemNames.length === 0) {
        return null;
      }

      const unlocked = {};
      const availableItems = Object.keys(GAME_DATA.items);
      
      itemNames.forEach(inputName => {
        const exactMatch = availableItems.find(item => 
          item.toLowerCase() === inputName.toLowerCase()
        );
        
        if (exactMatch) {
          unlocked[exactMatch] = true;
        } else {
          const partialMatch = availableItems.find(item =>
            item.toLowerCase().includes(inputName.toLowerCase()) ||
            inputName.toLowerCase().includes(item.toLowerCase())
          );
          
          if (partialMatch) {
            unlocked[partialMatch] = true;
          }
        }
      });

      return Object.keys(unlocked).length > 0 ? unlocked : null;
    }

    function getCurrentInventory() {
      const inventory = {};
      const inputs = document.querySelectorAll('[id^="inv_"]');
      
      inputs.forEach(input => {
        const itemName = getItemNameFromInputId(input.id);
        if (itemName && input.value) {
          const count = parseInt(input.value) || 0;
          if (count > 0) {
            inventory[itemName] = count;
          }
        }
      });
      
      return inventory;
    }

    function getItemNameFromInputId(inputId) {
      if (!inputId.startsWith('inv_')) {
        return null;
      }
      
      return Object.keys(GAME_DATA.items).find(itemName => 
        createSafeId(itemName) === inputId
      );
    }

    function buildInventoryInputs() {
      const container = document.getElementById('inventoryContainer');
      if (!container) return;

      const tier = getCurrentTier();
      const customUnlocked = getCustomUnlocks();
      const includeHandCrafted = getIncludeHandCrafted();
      const availableItems = getAvailableItems(tier, customUnlocked, includeHandCrafted);

      if (availableItems.length === 0) {
        container.innerHTML = '<p class="small">No items available for the selected tier/settings.</p>';
        return;
      }

      let html = '<div class="inventory-container"><table>';
      html += '<thead><tr><th>Item</th><th>Quantity</th><th>Points Each</th><th>Production Rate</th><th>Complexity</th></tr></thead><tbody>';

      availableItems.forEach(([itemName, itemData]) => {
        const inputId = createSafeId(itemName);
        let itemClass = '';
        if (itemName.toLowerCase().includes('ficsmas')) {
          itemClass = 'event';
        }
        
        const productionDisplay = itemData.automatable && itemData.productionRate > 0 
          ? `${itemData.productionRate}/min` 
          : 'Hand-crafted';
        const productionClass = itemData.automatable && itemData.productionRate > 0 ? '' : 'cannot';
        
        const complexityStars = '★'.repeat(itemData.complexity);
        const complexityClass = itemData.complexity >= 4 ? 'cannot' : '';
        
        html += `
          <tr>
            <td class="${itemClass}">${sanitizeHtml(itemName)}</td>
            <td>
              <input 
                type="number" 
                min="0" 
                id="${inputId}" 
                style="width: 80px"
                placeholder="0"
              >
            </td>
            <td class="small">${formatNumber(itemData.points)}</td>
            <td class="small ${productionClass}">${productionDisplay}</td>
            <td class="small ${complexityClass}">${complexityStars}</td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      html += '<div class="small" style="margin-top: 8px;">';
      html += 'Enter quantities for items you currently have in storage.';
      html += '</div>';
      
      container.innerHTML = html;
    }

    function buildProductionInputs() {
      const container = document.getElementById('productionContainer');
      if (!container) return;

      const tier = getCurrentTier();
      const customUnlocked = getCustomUnlocks();
      const includeHandCrafted = getIncludeHandCrafted();
      const availableItems = getAvailableItems(tier, customUnlocked, includeHandCrafted);

      const automatableItems = availableItems.filter(([itemName, itemData]) => itemData.automatable);

      if (automatableItems.length === 0) {
        container.innerHTML = '<p class="small">No automatable items available for the selected tier/settings.</p>';
        return;
      }

      let html = '<div class="inventory-container"><table>';
      html += '<thead><tr><th>Item</th><th>Currently Producing (per min)</th><th>Max Realistic Rate</th><th>Complexity</th></tr></thead><tbody>';

      automatableItems.forEach(([itemName, itemData]) => {
        const inputId = createSafeId(itemName).replace('inv_', 'prod_');
        let itemClass = '';
        if (itemName.toLowerCase().includes('ficsmas')) {
          itemClass = 'event';
        }
        
        const maxRate = Math.round(itemData.productionRate * 1.5);
        const complexityStars = '★'.repeat(itemData.complexity);
        const complexityClass = itemData.complexity >= 4 ? 'cannot' : '';
        
        html += `
          <tr>
            <td class="${itemClass}">${sanitizeHtml(itemName)}</td>
            <td>
              <input 
                type="number" 
                min="0" 
                max="${maxRate}"
                id="${inputId}" 
                style="width: 80px"
                placeholder="0"
              >
            </td>
            <td class="small">${formatNumber(maxRate)}/min</td>
            <td class="small ${complexityClass}">${complexityStars}</td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      html += '<div class="small" style="margin-top: 8px;">';
      html += 'Enter how many items per minute you\'re currently producing (leave blank if not automated).';
      html += '</div>';
      
      container.innerHTML = html;
    }

    function displayError(message) {
      const container = document.getElementById('errorContainer');
      if (container) {
        container.innerHTML = `<div class="error">${sanitizeHtml(message)}</div>`;
        setTimeout(() => {
          container.innerHTML = '';
        }, 5000);
      }
    }

    function clearError() {
      const container = document.getElementById('errorContainer');
      if (container) {
        container.innerHTML = '';
      }
    }

    function displayResults(results) {
      const container = document.getElementById('resultsContainer');
      if (!container) return;

      const { 
        wantCoupons, 
        pointsNeeded, 
        recommendations, 
        alreadyPrinted = 0, 
        nextCouponNumber = 1, 
        finalCouponNumber = wantCoupons,
        timeEstimate = null,
        includeHandCrafted = false,
        sinkingRate = null
      } = results;
      
      let html = '<div class="result">';
      
      html += `<div class="stats">`;
      html += `<div class="stat-card">`;
      html += `<div class="stat-value">${wantCoupons}</div>`;
      html += `<div>Coupon${wantCoupons > 1 ? 's' : ''} Wanted</div>`;
      html += `</div>`;
      html += `<div class="stat-card">`;
      html += `<div class="stat-value">${formatNumber(pointsNeeded)}</div>`;
      html += `<div>Total Points Needed</div>`;
      html += `</div>`;
      html += `<div class="stat-card">`;
      html += `<div class="stat-value">${alreadyPrinted}</div>`;
      html += `<div>Coupons Already Printed</div>`;
      html += `</div>`;
      html += `<div class="stat-card">`;
      html += `<div class="stat-value">#${nextCouponNumber}-${finalCouponNumber}</div>`;
      html += `<div>Coupon Range</div>`;
      html += `</div>`;
      
      if (timeEstimate) {
        html += `<div class="stat-card">`;
        html += `<div class="stat-value">${timeEstimate.formattedShort}</div>`;
        html += `<div>Estimated Time</div>`;
        html += `</div>`;
      }
      
      html += `</div>`;

      if (timeEstimate) {
        html += '<div style="margin: 16px 0; padding: 12px; background: #2c3036; border-radius: 6px;">';
        html += '<div class="small">';
        html += `⏱️ At your current sinking rate, this will take approximately <strong>${timeEstimate.formattedLong}</strong>.`;
        html += '</div>';
        html += '</div>';
      }

      if (alreadyPrinted > 0 || wantCoupons > 1) {
        html += '<div style="margin: 16px 0; padding: 12px; background: #2c3036; border-radius: 6px;">';
        html += '<div class="small">';
        if (alreadyPrinted > 0) {
          html += `You have already printed <strong>${alreadyPrinted}</strong> coupon${alreadyPrinted > 1 ? 's' : ''}. `;
        }
        html += `This calculation will get you coupon${wantCoupons > 1 ? 's' : ''} <strong>#${nextCouponNumber}`;
        if (wantCoupons > 1) {
          html += ` through #${finalCouponNumber}`;
        }
        html += '</strong>.';
        html += '</div>';
        html += '</div>';
      }

      if (recommendations.length > 0) {
        html += '<h3>Recommended Items to Sink:</h3>';
        html += '<div class="recommendations">';
        
        recommendations.forEach(rec => {
          let itemClass = '';
          if (rec.isEvent) itemClass += 'event ';
          if (!rec.isAutomatable) itemClass += 'cannot ';
          
          html += `<div class="recommendation-item">`;
          html += `<div class="item-name ${itemClass}">${sanitizeHtml(rec.item)}`;
          if (!rec.isAutomatable) {
            html += ` <span style="font-size: 0.8em; opacity: 0.7;">(Hand-crafted)</span>`;
          }
          html += `</div>`;
          html += `<div class="item-details">`;
          html += `Need: <strong>${formatNumber(rec.needed)}</strong> items `;
          html += `(${formatNumber(rec.points)} points each = ${formatNumber(rec.needed * rec.points)} total points)`;
          
          if (sinkingRate) {
            const itemTotalPoints = rec.needed * rec.points;
            const itemTimeEstimate = calculateTimeEstimate(itemTotalPoints, sinkingRate);
            if (itemTimeEstimate) {
              html += ` | <strong style="color: #7fdfff;">⏱️ ${itemTimeEstimate.formattedShort}</strong>`;
            }
          }
          
          if (rec.have > 0) {
            html += ` | You have: <strong>${formatNumber(rec.have)}</strong>`;
          }
          html += `</div>`;
          html += `</div>`;
        });
        
        html += '</div>';
      } else {
        html += '<p>No suitable items found for your current tier/unlocks.</p>';
      }

      html += '<div class="small" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #333;">';
      html += 'Items are sorted by efficiency (fewest items needed first). ';
      if (!includeHandCrafted) {
        html += 'Currently showing <strong>automated items only</strong> - check "Include hand-crafted items" to see all options. ';
      }
      html += '</div>';
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Main calculation function
    function calculate() {
      clearError();

      try {
        const wantCoupons = parseInt(document.getElementById('numCoupons').value) || 1;
        const pointsToNext = parseInt(document.getElementById('points').value) || 500;
        const selectedTier = getCurrentTier();
        
        if (wantCoupons < 1 || wantCoupons > CONFIG.MAX_COUPONS) {
          throw new Error(`Number of coupons must be between 1 and ${CONFIG.MAX_COUPONS}`);
        }
        
        if (pointsToNext < 0) {
          throw new Error('Points to next coupon cannot be negative');
        }
        
        const calculationResult = calculateCumulativeCost(pointsToNext, wantCoupons);
        const customUnlocked = getCustomUnlocks();
        const inventory = getCurrentInventory();
        const includeHandCrafted = getIncludeHandCrafted();
        const sinkingRate = getCurrentSinkingRate();

        const recommendations = generateRecommendations(
          calculationResult.totalPointsNeeded,
          selectedTier,
          customUnlocked,
          inventory,
          includeHandCrafted,
          sinkingRate
        );

        const timeEstimate = sinkingRate ? 
          calculateTimeEstimate(calculationResult.totalPointsNeeded, sinkingRate) : 
          null;

        displayResults({
          wantCoupons,
          pointsNeeded: calculationResult.totalPointsNeeded,
          recommendations,
          alreadyPrinted: calculationResult.alreadyPrinted,
          nextCouponNumber: calculationResult.nextCouponNumber,
          finalCouponNumber: calculationResult.finalCouponNumber,
          timeEstimate,
          includeHandCrafted,
          sinkingRate
        });

      } catch (error) {
        displayError(error.message);
      }
    }

    // Event listeners and initialization
    function attachEventListeners() {
      const tierSelect = document.getElementById('tierSelect');
      const customUnlocked = document.getElementById('customUnlocked');
      const showHandCrafted = document.getElementById('showHandCrafted');
      
      if (tierSelect) {
        tierSelect.addEventListener('change', () => {
          buildInventoryInputs();
          buildProductionInputs();
        });
      }
      
      if (customUnlocked) {
        customUnlocked.addEventListener('input', () => {
          buildInventoryInputs();
          buildProductionInputs();
        });
      }
      
      if (showHandCrafted) {
        showHandCrafted.addEventListener('change', () => {
          buildInventoryInputs();
          buildProductionInputs();
        });
      }
    }

    // Initialize the optimizer
    window.optimizer = {
      calculate: calculate
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      attachEventListeners();
      buildInventoryInputs();
      buildProductionInputs();
    });
  </script>
</body>
</html>
